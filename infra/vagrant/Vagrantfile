Vagrant.configure("2") do |config|
  (1..3).each do |i|
    config.vm.define "kafka#{i}" do |node|
      node.vm.box = "bento/ubuntu-22.04"
      node.vm.hostname = "kafka#{i}"
      node.vm.network "private_network", ip: "192.168.56.1#{i}"
      node.vm.provider "virtualbox" do |vb|
        vb.memory = 2048
        vb.cpus = 2
      end
      node.vm.provision "shell", inline: <<-SHELL
        apt-get update
        apt-get install -y docker.io docker-compose-plugin
        usermod -aG docker vagrant
        mkdir -p /opt/kraft
        cat >/opt/kraft/docker-compose.yml <<'EOF'

version: "3.9"
services:
  {{THIS_NODE}}:
    image: bitnami/kafka:3.7.0
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@{{BROKER_1}}:9093,2@{{BROKER_2}}:9093,3@{{BROKER_3}}:9093
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://{{THIS_NODE}}:9092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=3
      - KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR=2
      - KAFKA_CFG_MIN_INSYNC_REPLICAS=2
      - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=3

EOF
        sed -i "s/{{THIS_NODE}}/kafka#{i}/" /opt/kraft/docker-compose.yml
        sed -i "s/{{BROKER_1}}/192.168.56.11/" /opt/kraft/docker-compose.yml
        sed -i "s/{{BROKER_2}}/192.168.56.12/" /opt/kraft/docker-compose.yml
        sed -i "s/{{BROKER_3}}/192.168.56.13/" /opt/kraft/docker-compose.yml
        docker compose -f /opt/kraft/docker-compose.yml up -d
      SHELL
    end
  end
end
